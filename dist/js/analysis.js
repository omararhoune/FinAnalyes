const IS_LOCAL=window.location.hostname.includes("localhost")||window.location.hostname.includes("127.0.0.1"),API_BASE=IS_LOCAL?"http://localhost:8000/api":"https://finanalyses.onrender.com/api";let currentCompanyData=null,stockChartInstance=null,dividendChartInstance=null;const safe=(e,t=String)=>null==e||isNaN(e)?"N/A":t(e),formatCurrencyBillion=e=>`$${(e/1e9).toFixed(1)}B`,formatPercentage=e=>`${(100*e).toFixed(1)}%`;function calculateFinancialScore(e){let t=0;return e.roe>.2?t+=2:e.roe>.1&&(t+=1),e.netMargin>.15?t+=2:e.netMargin>.05&&(t+=1),e.peRatio>0&&e.peRatio<15?t+=3:e.peRatio<25?t+=2:e.peRatio<40&&(t+=1),e.debtToEquity<.5?t+=3:e.debtToEquity<1?t+=2:e.debtToEquity<2&&(t+=1),e.revenue>1e11?t+=2:e.revenue>2e10&&(t+=1),e.dividendYield>.03?t+=2:e.dividendYield>.01&&(t+=1),Math.min(10,Math.round(t/14*100)/10)}function generateFinancialComment(e,t){let n=`Avec un score de ${t.toFixed(1)}/10, ${e.name} `;return n+=t>=8?"présente une excellente santé financière. ":t>=6?"affiche une situation financière solide. ":t>=4?"montre une performance financière moyenne avec des points à surveiller. ":"présente des défis financiers significatifs. ",n}function createStat(e,t){return`<div class="bg-gray-50 p-2 rounded-lg"><p class="text-xs text-gray-500">${e}</p><p class="text-md font-semibold">${t}</p></div>`}function updateUICards(e,t,n,a){document.getElementById("company-card").innerHTML=`<h3 class="text-xl font-bold text-gray-800">${e.name}</h3><p class="text-gray-600 mb-4">${e.symbol}</p><div class="space-y-2 text-sm"><p><i class="fas fa-industry w-5 text-gray-400 mr-2"></i>${e.sector}</p><p><i class="fas fa-globe w-5 text-gray-400 mr-2"></i>${e.country}</p><p><i class="fas fa-dollar-sign w-5 text-gray-400 mr-2"></i><span class="font-semibold">${safe(e.price,e=>`$${e.toFixed(2)}`)}</span></p></div>`;const i=n/10*120;document.getElementById("score-card").innerHTML=`<h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Score Financier</h3><div class="text-center my-4"><span class="text-5xl font-bold" style="color: hsl(${i}, 80%, 45%)">${n.toFixed(1)}</span><span class="text-2xl text-gray-500">/10</span></div>`,document.getElementById("analysis-comment").textContent=a,document.getElementById("quick-stats-card").innerHTML=`<h3 class="text-lg font-semibold text-gray-800 mb-4">Indicateurs Clés</h3><div class="grid grid-cols-2 gap-2">${createStat("Chiffre d'affaires",safe(e.revenue,formatCurrencyBillion))}${createStat("PER",safe(e.peRatio,e=>e.toFixed(1)))}${createStat("ROE",safe(e.roe,formatPercentage))}${createStat("Marge nette",safe(e.netMargin,formatPercentage))}</div>`,document.getElementById("advanced-metrics-grid").innerHTML=`${createStat("Dette/Cap. Propres",safe(t.debtToEquity,e=>e.toFixed(2)))} ${createStat("Dividende (Yield)",safe(t.dividendYield,formatPercentage))}`}function createChart(e,t,n,a){const i=document.getElementById(e).getContext("2d");if(!i)return;"stock-chart"===e&&stockChartInstance&&stockChartInstance.destroy(),"dividend-chart"===e&&dividendChartInstance&&dividendChartInstance.destroy();const s=new Chart(i,{type:t,data:n,options:a});"stock-chart"===e&&(stockChartInstance=s),"dividend-chart"===e&&(dividendChartInstance=s)}async function analyzeCompany(e){const t=document.getElementById("loading-state"),n=document.getElementById("analysis-content"),a=document.getElementById("error-state"),i=document.getElementById("error-message");t.classList.remove("hidden"),n.classList.add("hidden"),a.classList.add("hidden");try{const[t,a,i,s]=await Promise.all([fetch(`${API_BASE}/entreprise/${e}`),fetch(`${API_BASE}/historique/${e}`),fetch(`${API_BASE}/advanced-metrics/${e}`),fetch(`${API_BASE}/dividends/${e}`)]);if(!t.ok)throw new Error((await t.json()).detail||"Données financières non trouvées.");const r=await t.json(),d=await a.json(),o=await i.json(),c=await s.json();currentCompanyData={...r,...o};const l=calculateFinancialScore(currentCompanyData),m=generateFinancialComment(r,l);document.title=`${r.name} (${r.symbol}) - FinAnalyse`,document.getElementById("analysis-title").textContent=`Analyse de ${r.name}`,updateUICards(r,o,l,m),createChart("stock-chart","line",{labels:d.dates,datasets:[{label:"Prix ($)",data:d.prices,borderColor:"#3b82f6",fill:!0}]},{responsive:!0,maintainAspectRatio:!1});const u=document.getElementById("dividend-chart").parentElement;c.dividendHistory&&c.dividendHistory.amounts.length>0?(u.innerHTML='<canvas id="dividend-chart"></canvas>',createChart("dividend-chart","bar",{labels:c.dividendHistory.years,datasets:[{label:"Dividende Annuel ($)",data:c.dividendHistory.amounts,backgroundColor:"#10b981"}]},{responsive:!0,maintainAspectRatio:!1})):u.innerHTML='<p class="text-center text-gray-500 h-full flex items-center justify-center">Aucune donnée de dividende disponible.</p>',n.classList.remove("hidden")}catch(e){a.classList.remove("hidden"),i.textContent=`Erreur : ${e.message}. Vérifiez le symbole et réessayez.`,document.title="Erreur - FinAnalyse"}finally{t.classList.add("hidden")}}document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search).get("ticker");if(e)analyzeCompany(e.toUpperCase());else{document.getElementById("loading-state").classList.add("hidden");document.getElementById("error-state").classList.remove("hidden"),document.getElementById("error-message").innerHTML='Aucun symbole boursier fourni. <a href="index.html" class="font-bold underline">Retour à l\'accueil</a>.'}});